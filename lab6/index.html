<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Lab #5</title>
    <style>
        body {
            font-family: Arial;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #2d3748;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255,255,255,0.9);
            padding: 20px;
            border-radius: 8px;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        
        button {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 6px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        button:hover {
            background: #27ae60;
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }
        
        input, textarea {
            width: 95%;
            padding: 12px;
            margin: 8px 0;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            background: white;
            transition: border-color 0.3s;
        }
        
        input:focus, textarea:focus {
            border-color: #2ecc71;
            outline: none;
        }
        
        .status {
            padding: 12px;
            margin: 12px 0;
            background: #d4f3e0;
            border: 2px solid #2ecc71;
            border-radius: 8px;
            color: #166534;
        }
        
        .result-block {
            padding: 16px;
            margin: 16px 0;
            background: white;
            border: 2px solid #d4f3e0;
            border-radius: 8px;
        }
        
        .friend-card {
            display: flex;
            align-items: center;
            padding: 12px;
            margin: 12px 0;
            background: white;
            border: 2px solid #d4f3e0;
            border-radius: 8px;
        }
        
        .friend-photo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
            border: 2px solid #2ecc71;
        }
        
        h2 {
            color: #166534;
            font-size: 20px;
            margin: 18px 0;
            border-left: 4px solid #2ecc71;
            padding-left: 12px;
        }

        /* –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ */
        #postEditorBlock button {
            background: #3498db;
            margin: 10px 5px;
        }
        
        #postEditorBlock button:last-child {
            background: #e74c3c;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
</head>
<body>
<div class="container">
    <h2>üîë –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
    <input type="text" id="manualToken" placeholder="–í–≤–µ–¥–∏—Ç–µ access token">
    <button onclick="setToken()">‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω</button>
    <button onclick="authVK()">üîì –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –í–ö</button>
    <div class="status" id="status">üì° –°—Ç–∞—Ç—É—Å: –û–∂–∏–¥–∞–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</div>

    <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
    <input type="number" id="limit" value="5" placeholder="–ú–∞–∫—Å. –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–ø–µ—Ä–∞—Ü–∏–π">

    <h2>üöÄ –§—É–Ω–∫—Ü–∏–∏</h2>
    <input type="text" id="groupId" placeholder="ID –≥—Ä—É–ø–ø—ã">
    <button onclick="getGroupFriends()">üë• –î—Ä—É–∑—å—è –≥—Ä—É–ø–ø—ã</button>
    <button onclick="createGroupsPost()">üìù –°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç</button>
    <button onclick="findPopularFriend()">üèÜ –ü–æ–ø—É–ª—è—Ä–Ω—ã–π –¥—Ä—É–≥</button>
    <button onclick="processNewsfeed()">üì∞ –ê–Ω–∞–ª–∏–∑ –ª–µ–Ω—Ç—ã</button>

    <div class="result-block" id="postEditorBlock" style="display: none;">
        <h2>‚úçÔ∏è –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ø–æ—Å—Ç–∞</h2>
        <textarea id="postPreview" rows="6" style="width: 95%"></textarea>
        <button onclick="publishPost()" style="background: #3498db">üöÄ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
        <button onclick="document.getElementById('postEditorBlock').style.display = 'none'" 
                style="background: #e74c3c">‚ùå –û—Ç–º–µ–Ω–∏—Ç—å</button>
    </div>

    <div class="result-block">
        <h2>üìå –ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ—Å—Ç</h2>
        <div id="lastPostContent">‚è≥ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...</div>
    </div>

    <div class="result-block">
        <h2>üåü –ü–æ–ø—É–ª—è—Ä–Ω—ã–π –¥—Ä—É–≥</h2>
        <div id="popularFriendContent">üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏</div>
    </div>
</div>

<script>
    const APP_ID = 53162697;
    let accessToken = null;

    function setToken() {
        accessToken = document.getElementById('manualToken').value.trim();
        document.getElementById('status').innerHTML = accessToken 
            ? '‚úÖ –¢–æ–∫–µ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' 
            : '‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω';
    }

    function authVK() {
        const redirectUri = "https://oauth.vk.com/blank.html";
        const scope = ["wall,friends,groups,stats,offline"];
        const url = new URL(`https://oauth.vk.com/authorize?client_id=${APP_ID}&display=page&redirect_uri=${redirectUri}&scope=${scope}&response_type=token&v=5.199`);
        window.open(url.href, 'VK Auth', 'width=600,height=700');
    }

    function callAPI(method, params) {
        return $.ajax({
            url: `https://api.vk.com/method/${method}`,
            data: {
                ...params,
                access_token: accessToken,
                v: '5.199'
            },
            dataType: 'jsonp',
            jsonp: 'callback'
        });
    }

    function handleError(jqXHR) {
        alert('–û—à–∏–±–∫–∞: ' + (jqXHR.responseJSON?.error?.error_msg || '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'));
    }

    async function createGroupsPost() {
        try {
            const groups = await callAPI('groups.get', {
                extended: 1,
                count: $('#limit').val()
            });

            let postText = "–ú–æ–∏ –≥—Ä—É–ø–ø—ã:\\n\\n";
            for(const group of groups.response.items) {
                const response = await callAPI('groups.getById', {
                    'group_id': Math.abs(group.id),
                    fields: "members_count"
                });
                postText += `${group.name} (${response.response.groups[0].members_count} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤)\\n`;
                await new Promise(r => setTimeout(r, 500));
            }

            document.getElementById('postEditorBlock').style.display = 'block';
            document.getElementById('postPreview').value = postText.replace(/\\n/g, '\n');

        } catch(e) {
            handleError(e);
        }
    }

    async function publishPost() {
        try {
            const finalText = document.getElementById('postPreview').value;
            await callAPI('wall.post', { message: finalText });
            alert('–ü–æ—Å—Ç —É—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!');
            document.getElementById('postEditorBlock').style.display = 'none';
        } catch(e) {
            handleError(e);
        }
    }

    async function getGroupFriends() {
        const groupId = $('#groupId').val();
        const limit = $('#limit').val();

        try {
            const members = await callAPI('groups.getMembers', {
                group_id: groupId,
                count: 1000
            });

            const friends = [];
            for(const member of members.response.items.slice(0, limit)) {
                const response = await callAPI('friends.get', {
                    user_id: member
                });
                if(response.response) friends.push(...response.response.items);
            }

            alert(`–ù–∞–π–¥–µ–Ω–æ –¥—Ä—É–∑–µ–π: ${friends.length}`);
        } catch(e) {
            handleError(e);
        }
    }


    async function findPopularFriend() {
        try {
            const friends = await callAPI('friends.get', {});
            let maxFriends = 0;
            let popularUser = null;

            for(const friendId of friends.response.items.slice(0, $('#limit').val())) {
                const friend = await callAPI('users.get', {
                    user_ids: friendId,
                    fields: 'photo_100,counters'
                });
				console.log(friendId)
				console.log(friend)
                if(friend.response[0].counters && friend.response[0].counters.friends > maxFriends) {
                    maxFriends = friend.response[0].counters.friends;
                    popularUser = friend.response[0];
                }
				
				await new Promise(r => setTimeout(r, 500));
            }

            document.getElementById('popularFriendContent').innerHTML = `
        <div class="friend-card">
          <img src="${popularUser.photo_100}"
               class="friend-photo"
               alt="${popularUser.first_name} ${popularUser.last_name}">
          <div>
            <h4>${popularUser.first_name} ${popularUser.last_name}</h4>
            <p>–î—Ä—É–∑–µ–π: ${maxFriends}</p>
            <p>–°—Ç—Ä–∞–Ω–∏—Ü–∞: <a href="https://vk.com/id${popularUser.id}"
                         target="_blank">–ø–µ—Ä–µ–π—Ç–∏</a></p>
          </div>
        </div>
      `;

        } catch(e) {
            handleError(e);
        }
    }

    async function processNewsfeed() {
        try {
            const news = await callAPI('newsfeed.get', { count: 1 });
            const post = news.response.items[0];

            let names = [];
            if(post.source_id > 0) {
                const friends = await callAPI('friends.get', {
                    user_id: post.source_id,
                    count: $('#limit').val()
                });
                names = await getNames(friends.response.items);
            } else {
                const groupId = Math.abs(post.source_id);
                const members = await callAPI('groups.getMembers', {
                    group_id: groupId,
                    count: $('#limit').val()
                });
                names = await getNames(members.response.items);
            }

            const isGroup = post.source_id < 0;
            const response = await callAPI(isGroup ? 'groups.getById' : 'users.get', {
                [isGroup ? 'group_id' : 'user_ids']: Math.abs(post.source_id),
                fields: "photo_100"
            });

            const name = isGroup
                ? response.response.groups[0].name
                : `${response.response[0].first_name} ${response.response[0].last_name}`;

            const photo = isGroup ? response.response.groups[0].photo_100 : response.response[0].photo_100

			console.log(post)
			const attachment = post.attachments[0].type == "photo" ? post.attachments[0].photo.sizes[1].url : ""
			
            document.getElementById('lastPostContent').innerHTML = `
            <div class="friend-card">
                <img src="${photo}" class="friend-photo">
                <div style="display: contents;">
                    <h4>${name} ${new Date(post.date * 1000).toLocaleString()}</h4>
                    <p>${post.text || '–ë–µ–∑ —Ç–µ–∫—Å—Ç–∞'}</p>
                    <img src="${attachment}" alt="–ë–µ–∑ —Ñ–æ—Ç–æ">
                </div>
            </div>
            `;

            alert(`–°–ø–∏—Å–æ–∫:\n${names.join('\n')}`);
        } catch(e) {
            handleError(e);
        }
    }

    async function getNames(ids) {
        const users = await callAPI('users.get', {
            user_ids: ids.join(','),
            fields: 'name'
        });
        return users.response.map(u => `${u.first_name} ${u.last_name}`);
    }
</script>
</body>
</html>